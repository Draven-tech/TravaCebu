<ion-header *ngIf="!isFullscreen">
  <ion-toolbar color="warning">
    <ion-title>Map</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showCuratedRouteDetailsSheet()" style="--color: white; font-weight: bold; margin-right: 8px;">
        <ion-icon name="list"></ion-icon>
        Route Info
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Search Bar (show when no itinerary selected) -->
  <ion-toolbar *ngIf="selectedItineraryIndex < 0">
    <ion-searchbar [(ngModel)]="searchQuery" placeholder="Search tourist spots..."></ion-searchbar>
  </ion-toolbar>
  
  
</ion-header>

<!-- Stage Notification Banner -->
<div *ngIf="currentRouteInfo && currentRouteInfo.segments && currentRouteInfo.segments.length > 0 && showStageNotification" 
     class="stage-notification"
     [ngStyle]="{ top: isFullscreen ? '0' : '56px' }">
  <div class="stage-content">
    <ion-icon name="navigate" class="stage-icon"></ion-icon>
    <div class="stage-text">
      <span class="stage-title">Stage {{ currentSegmentIndex + 1 }}/{{ currentRouteInfo.segments.length }}</span>
      <span class="stage-description">{{ getCurrentStageDescription() }}</span>
    </div>
  </div>
</div>

<ion-content [class.fullscreen-mode]="isFullscreen">
  <div id="map"></div>
  
  
  <!-- Map Controls (show when no itinerary selected) -->
  <div *ngIf="selectedItineraryIndex < 0 && !isFullscreen" class="map-controls">
    <ion-button expand="block" color="primary" (click)="navigateNextItineraryStep()" [disabled]="navigating">
      Navigate Next Itinerary Step
    </ion-button>
    <ion-list *ngIf="navigationInstructions.length > 0">
      <ion-item *ngFor="let instr of navigationInstructions">
        <div [innerHTML]="instr"></div>
      </ion-item>
    </ion-list>
  </div>
  
  <!-- Itinerary Controls (show when itinerary is selected) -->
  <div *ngIf="selectedItineraryIndex >= 0 && !isFullscreen" class="directions-controls">
    <!-- Auto-loading indicator for jeepney route suggestions -->
    <ion-item *ngIf="selectedItineraryIndex >= 0 && availableItineraries.length > 0 && isLoadingJeepneyRoutes" lines="none" style="margin: 16px;">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>
        <h3>Loading jeepney routes...</h3>
        <p>Finding jeepney codes and walking directions for your itinerary</p>
      </ion-label>
    </ion-item>

    <!-- Loading indicator for route generation -->
    <ion-item *ngIf="selectedItineraryIndex >= 0 && availableItineraries.length > 0 && isGeneratingRoute" lines="none" style="margin: 16px;">
      <ion-spinner name="crescent" slot="start" color="warning"></ion-spinner>
      <ion-label>
        <h3>Generating Stage Routes...</h3>
        <p>Fetching jeepney routes from Google Maps API via proxy server</p>
      </ion-label>
    </ion-item>

    <!-- Route Information Display -->
    <div *ngIf="currentRouteInfo" class="route-suggestions">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Stage-Based Route</ion-card-title>
          <ion-card-subtitle>
            {{ currentRouteInfo.totalDuration }} ‚Ä¢ {{ currentRouteInfo.totalDistance }}
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <!-- Direct segments display -->
          <ion-list *ngIf="currentRouteInfo.segments && currentRouteInfo.segments.length > 0">
            <ion-item *ngFor="let segment of currentRouteInfo.segments; let i = index">
              <ion-icon [name]="segment.type === 'jeepney' ? 'bus' : 'walk'" 
                        [color]="segment.type === 'jeepney' ? 'primary' : 'medium'" 
                        slot="start"></ion-icon>
              <ion-label>
                <h3>{{ segment.description }}</h3>
                <p *ngIf="segment.jeepneyCode">Jeepney Code: {{ segment.jeepneyCode }}</p>
                <p>{{ segment.estimatedTime || 'N/A' }} ‚Ä¢ Stage {{ segment.stage || 'N/A' }}</p>
              </ion-label>
              <ion-button *ngIf="segment.stage && stageRouteOptions[segment.stage - 1] && stageRouteOptions[segment.stage - 1].length > 1" 
                          fill="clear" size="small" slot="end" 
                          (click)="showStageRouteOptions((segment.stage || 1) - 1)">
                <ion-icon name="options" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
          
          <!-- Alternative Routes for Each Stage -->
          <div *ngIf="selectedStageForOptions >= 0 && stageRouteOptions[selectedStageForOptions]" class="stage-route-options">
            <ion-card>
              <ion-card-header>
                <ion-card-title>Stage {{ selectedStageForOptions + 1 }} - Alternative Routes</ion-card-title>
                <ion-card-subtitle>Choose from {{ stageRouteOptions[selectedStageForOptions].length }} available options</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-list>
                  <ion-item *ngFor="let route of stageRouteOptions[selectedStageForOptions]; let i = index" 
                            [class.selected-route]="i === 0"
                            (click)="selectStageRoute(selectedStageForOptions, i)">
                    <ion-icon [name]="hasJeepneySegments(route) ? 'bus' : 'walk'" 
                              [color]="hasJeepneySegments(route) ? 'primary' : 'medium'" 
                              slot="start"></ion-icon>
                    <ion-label>
                      <h3>Option {{ i + 1 }}</h3>
                      <p *ngFor="let segment of route.segments">
                        <span *ngIf="segment.type === 'jeepney'">üöå {{ segment.jeepneyCode }} - {{ segment.description }}</span>
                        <span *ngIf="segment.type === 'walk'">üö∂‚Äç‚ôÇÔ∏è {{ segment.description }}</span>
                      </p>
                      <p>{{ formatDuration(route.totalDuration) }} ‚Ä¢ {{ (route.totalDistance / 1000).toFixed(1) }} km</p>
                    </ion-label>
                    <ion-badge *ngIf="i === 0" color="success" slot="end">Recommended</ion-badge>
                  </ion-item>
                </ion-list>
              </ion-card-content>
            </ion-card>
          </div>
          
          <!-- Suggested routes display (if available) -->
          <ion-list *ngIf="currentRouteInfo.suggestedRoutes && currentRouteInfo.suggestedRoutes.length > 0">
            <ion-item *ngFor="let route of currentRouteInfo.suggestedRoutes; let i = index" 
                      [class.selected-route]="i === currentRouteInfo.selectedRouteIndex"
                      (click)="selectRoute(i)">
              <ion-label>
                <h3>{{ route.title }}</h3>
                <p>{{ route.summary }}</p>
                <p>{{ route.totalDuration }} ‚Ä¢ {{ route.totalDistance }} ‚Ä¢ {{ route.totalFare }}</p>
              </ion-label>
              <ion-badge *ngIf="route.isRecommended" color="success" slot="end">Recommended</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Legacy Route Suggestions Display -->
    <div *ngIf="currentRouteInfo && currentRouteInfo.suggestedRoutes && !currentRouteInfo.segments" class="route-suggestions">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Route Suggestions</ion-card-title>
          <ion-card-subtitle>
            {{ currentRouteInfo.totalDuration }} ‚Ä¢ {{ currentRouteInfo.totalDistance }} ‚Ä¢ {{ currentRouteInfo.totalFare }}
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let route of currentRouteInfo.suggestedRoutes; let i = index" 
                      [class.selected-route]="i === currentRouteInfo.selectedRouteIndex"
                      (click)="selectRoute(i)">
              <ion-label>
                <h3>{{ route.title }}</h3>
                <p>{{ route.summary }}</p>
                <p>{{ route.totalDuration }} ‚Ä¢ {{ route.totalDistance }} ‚Ä¢ {{ route.totalFare }}</p>
              </ion-label>
              <ion-badge *ngIf="route.isRecommended" color="success" slot="end">Recommended</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- No Route Info Message -->
    <ion-card *ngIf="selectedItineraryIndex < 0">
      <ion-card-content>
        <ion-text color="medium">
          <p>Select an itinerary to automatically show jeepney route suggestions</p>
        </ion-text>
      </ion-card-content>
    </ion-card>
  </div>
  
  <!-- Navigation Buttons (Left Side) -->
  <div *ngIf="currentRouteInfo && currentRouteInfo.segments && currentRouteInfo.segments.length > 0" 
       style="position: fixed; left: 16px; z-index: 9999;">
    
    <!-- Complete Itinerary Button -->
    <div [style.bottom]="isFullscreen ? '148px' : '228px'" 
         style="background: #28a745; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease; position: fixed; left: 16px;" 
         (click)="stopItinerary()">
      <ion-icon name="checkmark" style="color: white; font-size: 24px;"></ion-icon>
    </div>
    
    <!-- Back Button -->
    <div [style.bottom]="isFullscreen ? '20px' : '100px'" 
         style="background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease; position: fixed; left: 16px;" 
         (click)="previousSegment()">
      <ion-icon name="arrow-back" style="color: white; font-size: 24px;"></ion-icon>
    </div>
    
    <!-- Next Button -->
    <div [style.bottom]="isFullscreen ? '84px' : '164px'" 
         style="background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease; position: fixed; left: 16px;" 
         (click)="nextSegment()">
      <ion-icon name="arrow-forward" style="color: white; font-size: 24px;"></ion-icon>
    </div>
  </div>
  
  <!-- Controls Button -->
  <div [style.bottom]="isFullscreen ? '230px' : '310px'" 
       style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" 
       (click)="showItineraryControlsModal()">
    <ion-icon name="settings" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <!-- Location Button -->
  <div [style.bottom]="isFullscreen ? '160px' : '240px'" 
       style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" 
       (click)="showUserLocation()">
    <ion-icon name="location" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <!-- Map Type Toggle Button -->
  <div [style.bottom]="isFullscreen ? '90px' : '170px'" style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" (click)="toggleMapType()">
    <ion-icon [name]="selectedTile === 'esri' ? 'earth' : 'map'" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <!-- Fullscreen Button -->
  <div [style.bottom]="isFullscreen ? '20px' : '100px'" style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" (click)="toggleFullscreen()">
    <ion-icon [name]="isFullscreen ? 'contract' : 'expand'" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <app-bottom-nav *ngIf="!isFullscreen"></app-bottom-nav>
</ion-content>