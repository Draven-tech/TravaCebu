<ion-header [translucent]="true">
  <ion-toolbar color="warning">
    <ion-buttons slot="start">
      <ion-button fill="clear" routerLink="/admin/dashboard">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Event Management</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="refreshEvents()">
        <ion-icon name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="event-content">
  
  <div class="profile-tabs">
    <button [class.active]="activeTab === 'event-list'" (click)="setActiveTab('event-list')">Event List</button>
    <button [class.active]="activeTab === 'calendar'" (click)="setActiveTab('calendar')">Calendar</button>
  </div>
  
  <div class="search-section" *ngIf="activeTab === 'event-list'">
    <ion-searchbar placeholder="Search events..." [(ngModel)]="searchQuery" (ionInput)="onSearchInput($event)"></ion-searchbar>
  </div>
  <!-- Event List Tab Content -->
  <div *ngIf="activeTab === 'event-list'" class="tab-content">
    <!-- Previous Events Button (like CLEAR ALL) -->
    <span class="clear-text-button" (click)="openPreviousEventsModal()">PREVIOUS EVENTS</span>
    
    <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
      <ion-spinner name="crescent" color="warning"></ion-spinner>
    <p>Loading events...</p>
  </div>
  
    <!-- Events List - Simple Display (Photo + Title Only) with Yellow Box -->
    <div *ngIf="!isLoading" class="events-container">
      <ion-item-sliding *ngFor="let event of getUpcomingEvents()" class="event-sliding-card">
        <ion-item-options side="end">
          <ion-item-option color="danger" (click)="deleteEvent(event.id)">Remove</ion-item-option>
        </ion-item-options>

        <ion-item lines="none" class="event-card-horizontal" (click)="openEventDetailModal(event)">
          <ion-thumbnail slot="start" class="event-thumbnail">
            <img *ngIf="event.imageUrl" [src]="event.imageUrl" [alt]="event.name" />
            <div *ngIf="!event.imageUrl" class="thumbnail-placeholder">
              <ion-icon name="calendar" color="warning"></ion-icon>
            </div>
          </ion-thumbnail>
        <ion-label>
            <h3 class="event-title">{{ event.name || 'Untitled Event' }}</h3>
        </ion-label>
        </ion-item>
      </ion-item-sliding>
    </div>

    <!-- Pagination (like user dashboard) -->
    <div class="pagination-container" *ngIf="!isLoading && totalPages > 1">
      <ion-button fill="clear" [disabled]="currentPage === 1" (click)="previousPage()">
        <ion-icon name="chevron-back"></ion-icon>
        Previous
      </ion-button>

      <div class="page-info">
        Page {{ currentPage }} of {{ totalPages }}
      </div>

      <ion-button fill="clear" [disabled]="currentPage === totalPages" (click)="nextPage()">
        Next
        <ion-icon name="chevron-forward"></ion-icon>
      </ion-button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && getUpcomingEvents().length === 0" class="empty-state">
      <div class="empty-icon">
        <ion-icon name="calendar-outline" color="medium"></ion-icon>
      </div>
      <h3>No events found</h3>
      <p *ngIf="searchQuery">Try adjusting your search terms or clear the search to see all events.</p>
      <p *ngIf="!searchQuery">Create your first event to get started with event management.</p>
      <ion-button fill="solid" color="warning" (click)="navigateToEditor()" class="create-event-btn">
        <ion-icon name="add" slot="start"></ion-icon>
        Create Event
      </ion-button>
    </div>
  </div>

  <!-- Calendar Tab Content -->
  <div *ngIf="activeTab === 'calendar'" class="tab-content">
    <div class="calendar-interface">
      <!-- Calendar Header -->
      <div class="calendar-header">
        <div class="calendar-controls">
          <ion-button fill="clear" (click)="previousMonth()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
          <h2 class="current-month">{{ getCurrentMonthYear() }}</h2>
          <ion-button fill="clear" (click)="nextMonth()">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
          <ion-segment [(ngModel)]="viewMode" mode="ios" color="warning">
            <ion-segment-button value="grid">
              <ion-icon name="grid-outline"></ion-icon>
              <ion-label>Grid</ion-label>
            </ion-segment-button>
            <ion-segment-button value="agenda">
              <ion-icon name="list-outline"></ion-icon>
              <ion-label>Agenda</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading || isNavigating" class="loading-state">
        <ion-spinner name="crescent"></ion-spinner>
        <p *ngIf="isLoading">Loading calendar events...</p>
        <p *ngIf="isNavigating">Loading calendar...</p>
      </div>

      <!-- Grid View -->
      <div *ngIf="!isLoading && !isNavigating && viewMode === 'grid'" class="grid-view">
        <!-- Calendar Grid -->
        <div class="calendar-grid">
          <!-- Day Headers -->
          <div class="calendar-day-headers">
            <div class="day-header" *ngFor="let day of getDayHeaders()" [ngClass]="{ 'current-day': isCurrentDayOfWeek(day) }">{{ day }}</div>
          </div>

          <!-- Calendar Days -->
          <div class="calendar-days">
            <div 
              *ngFor="let date of getCalendarDates(); trackBy: trackByDate" 
              class="calendar-day"
              [ngClass]="{
                'other-month': !isCurrentMonth(date),
                'today': isToday(date),
                'selected': isSelectedDate(date),
                'has-events': hasEvents(date)
              }"
              (click)="onDateSelected(date)"
            >
              <div class="day-number" [ngClass]="{ 'highlighted': hasEvents(date) }">
                {{ getDayNumber(date) }}
                <span *ngIf="hasEvents(date) && getEventCount(date) > 1" class="event-count">{{ getEventCount(date) }}</span>
              </div>
              
              <!-- Event Indicators -->
              <div class="event-indicators">
                <div 
                  *ngFor="let event of getEventsForDate(date); trackBy: trackByEventId"
                  class="event-dot"
                  [ngClass]="getEventColor(event)"
                  [title]="event.name"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Agenda View -->
      <div *ngIf="!isLoading && !isNavigating && viewMode === 'agenda'" class="agenda-view">
        <!-- Month Navigation Tabs -->
        <div class="month-tabs">
          <div class="month-tab" 
               *ngFor="let month of getMonthTabs()" 
               [ngClass]="{ 'active': month.isCurrent }"
               (click)="goToMonth(month.date)">
            {{ month.name }}
          </div>
        </div>

        <!-- Selected Date Info -->
        <div class="selected-date-info">
          <div class="date-circle">
            <span class="day-name">{{ getSelectedDayName() }}</span>
            <span class="day-number">{{ getSelectedDayNumber() }}</span>
          </div>
          <div class="date-status">
            <span *ngIf="getEventsForSelectedDate().length === 0">Nothing planned.</span>
            <span *ngIf="getEventsForSelectedDate().length > 0">{{ getEventsForSelectedDate().length }} event(s) planned</span>
          </div>
        </div>

        <!-- Events List -->
        <div class="events-list">
          <div *ngFor="let weekGroup of getEventsGroupedByWeek()" class="week-group">
            <!-- Week Separator -->
            <div class="week-separator">
              {{ getWeekRange(weekGroup.weekStart) }}
            </div>
            
            <!-- Date Groups for this week -->
            <div *ngFor="let dateGroup of weekGroup.dateGroups" class="date-group">
              <!-- Date Header -->
              <div class="date-header">
                <div class="event-date">
                  <span class="day-name">{{ getEventDayName(dateGroup.events[0]) }}</span>
                  <span class="day-number">{{ getEventDayNumber(dateGroup.events[0]) }}</span>
                </div>
                <div class="date-status">
                  <span *ngIf="dateGroup.events.length === 0">Nothing planned.</span>
                  <span *ngIf="dateGroup.events.length > 0">{{ dateGroup.events.length }} event(s)</span>
                </div>
              </div>
              
              <!-- Events for this date -->
              <div *ngFor="let event of dateGroup.events" class="event-item" (click)="showEventDetails(event, $event)">
                <div class="event-content">
                  <div class="event-title">{{ event.name }}</div>
                  <div class="event-time" *ngIf="getEventTime(event)">
                    {{ getEventTime(event) }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Show message for empty weeks -->
            <div *ngIf="weekGroup.dateGroups.length === 0" class="empty-week">
              <div class="empty-week-message">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>No events this week</span>
              </div>
            </div>
          </div>

          <!-- No Events Message -->
          <div *ngIf="getAllEventsSorted().length === 0" class="no-events">
            <ion-icon name="calendar-outline" class="no-events-icon"></ion-icon>
            <h4>No events this month</h4>
            <p>Create admin events to see them appear in your calendar!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="warning" (click)="navigateToEditor()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Event Detail Modal -->
  <ion-modal [isOpen]="showEventModal" (didDismiss)="showEventModal = false" cssClass="event-detail-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar color="warning">
          <ion-title>Event Details</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showEventModal = false" fill="clear">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content *ngIf="selectedEvent" class="event-detail-content">
        <div class="event-detail-container">
          <!-- Event Image -->
          <div class="event-image-container" *ngIf="selectedEvent.imageUrl">
            <img [src]="selectedEvent.imageUrl" [alt]="selectedEvent.name" class="event-detail-image" />
          </div>
          
          <!-- Event Info -->
          <div class="event-info-section">
            <h1 class="event-detail-title">{{ selectedEvent.name || 'Untitled Event' }}</h1>
            
            <div class="event-detail-meta">
              <div class="meta-row">
                <ion-icon name="calendar-outline" color="warning"></ion-icon>
                <span>{{ formatEventDateTime(selectedEvent) }}</span>
              </div>
              
              <div class="meta-row" *ngIf="selectedEvent.location">
                <ion-icon name="location-outline" color="warning"></ion-icon>
                <span>{{ selectedEvent.location }}</span>
              </div>
              
              <div class="meta-row" *ngIf="selectedEvent.description">
                <ion-icon name="document-text-outline" color="warning"></ion-icon>
                <span>{{ selectedEvent.description }}</span>
              </div>
              
              <div class="meta-row">
                <ion-icon name="time-outline" color="warning"></ion-icon>
                <span>Created {{ selectedEvent.createdAt | date:'medium' }}</span>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="event-actions-section">
            <ion-button expand="block" color="primary" (click)="editEventFromModal(selectedEvent)">
              <ion-icon name="create" slot="start"></ion-icon>
              Edit Event
            </ion-button>
            
            <ion-button expand="block" color="danger" fill="outline" (click)="deleteEventFromModal(selectedEvent.id)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Delete Event
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Previous Events Modal -->
  <ion-modal [isOpen]="showPreviousEventsModal" (didDismiss)="showPreviousEventsModal = false" cssClass="previous-events-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar color="warning">
          <ion-title>Previous Events</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="showPreviousEventsModal = false" fill="clear">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="previous-events-content">
        <!-- Loading State -->
        <div *ngIf="isLoadingPastEvents" class="loading-container">
          <ion-spinner name="crescent" color="warning"></ion-spinner>
          <p>Loading previous events...</p>
        </div>

        <!-- Past Events List -->
        <div *ngIf="!isLoadingPastEvents" class="past-events-container">
          <ion-item-sliding *ngFor="let event of getPastEvents()" class="past-event-card">
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="deletePastEvent(event.id)">Remove</ion-item-option>
            </ion-item-options>

            <ion-item lines="none" class="past-event-item" (click)="openPastEventDetail(event)">
              <ion-thumbnail slot="start" class="past-event-thumbnail">
                <img *ngIf="event.imageUrl" [src]="event.imageUrl" [alt]="event.name" />
                <div *ngIf="!event.imageUrl" class="thumbnail-placeholder">
                  <ion-icon name="calendar" color="medium"></ion-icon>
                </div>
              </ion-thumbnail>
              <ion-label>
                <h3 class="past-event-title">{{ event.name || 'Untitled Event' }}</h3>
                <p class="past-event-date">{{ formatPastEventDate(event) }}</p>
                <p class="past-event-description" *ngIf="event.description">{{ event.description | slice:0:80 }}{{ event.description?.length > 80 ? '...' : '' }}</p>
              </ion-label>
              <ion-badge color="medium" slot="end" class="past-badge">
                <ion-icon name="time"></ion-icon>
                Past
              </ion-badge>
            </ion-item>
          </ion-item-sliding>
        </div>

        <!-- No Past Events -->
        <div *ngIf="!isLoadingPastEvents && getPastEvents().length === 0" class="no-past-events">
          <ion-icon name="calendar-outline" color="medium" size="large"></ion-icon>
          <h3>No previous events</h3>
          <p>Past events will appear here after their scheduled date has passed.</p>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Date Events Modal -->
  <ion-modal [isOpen]="showDateEventsModal" (didDismiss)="closeDateEventsModal()" cssClass="date-events-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar color="warning">
          <ion-title>{{ selectedDateString }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeDateEventsModal()" fill="clear">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="date-events-content">
        <div class="date-events-container">
          <!-- Event Count Header -->
          <div class="events-header">
            <ion-icon name="calendar" color="warning"></ion-icon>
            <h2>{{ selectedDateEvents.length }} Event{{ selectedDateEvents.length !== 1 ? 's' : '' }} Scheduled</h2>
            <p>Tap any event to view details</p>
          </div>

          <!-- Events List -->
          <div class="date-events-list">
            <ion-card *ngFor="let event of selectedDateEvents; trackBy: trackByEventId" class="date-event-card" (click)="openEventFromDateModal(event)">
              <ion-item lines="none" button>
                <ion-thumbnail slot="start" class="date-event-thumbnail">
                  <img *ngIf="event.imageUrl" [src]="event.imageUrl" [alt]="event.name" />
                  <div *ngIf="!event.imageUrl" class="thumbnail-placeholder">
                    <ion-icon name="calendar" color="warning"></ion-icon>
                  </div>
                </ion-thumbnail>
                
                <ion-label>
                  <h2 class="date-event-title">{{ event.name || 'Untitled Event' }}</h2>
                  <div class="date-event-details">
                    <div class="detail-row">
                      <ion-icon name="time-outline" color="warning"></ion-icon>
                      <span>{{ event.time }}</span>
                    </div>
                    <div class="detail-row" *ngIf="event.location">
                      <ion-icon name="location-outline" color="warning"></ion-icon>
                      <span>{{ event.location }}</span>
                    </div>
                    <div class="detail-row" *ngIf="event.description">
                      <ion-icon name="document-text-outline" color="warning"></ion-icon>
                      <span class="description-preview">{{ event.description | slice:0:60 }}{{ event.description?.length > 60 ? '...' : '' }}</span>
                    </div>
                  </div>
                </ion-label>
                
                <ion-icon name="chevron-forward" slot="end" color="medium"></ion-icon>
              </ion-item>
            </ion-card>
          </div>

          <!-- Quick Actions -->
          <div class="date-actions">
            <ion-button expand="block" color="warning" (click)="closeDateEventsModal(); navigateToEditor()" class="add-event-btn">
              <ion-icon name="add" slot="start"></ion-icon>
              Add Event to This Date
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
