<ion-header>
  <ion-toolbar color="warning">
    <ion-title>Map</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showCuratedRouteDetailsSheet()" style="--color: white; font-weight: bold; margin-right: 8px;">
        <ion-icon name="list"></ion-icon>
        Route Info
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Search Bar -->
  <ion-toolbar>
    <ion-searchbar [(ngModel)]="searchQuery" placeholder="Search tourist spots..."></ion-searchbar>
  </ion-toolbar>
  
  <!-- Tab Navigation -->
  <ion-segment [(ngModel)]="selectedTab" mode="ios" color="warning" (ionChange)="onTabChange()">
    <ion-segment-button value="spots">
      <ion-label>üìç Tourist Spots</ion-label>
    </ion-segment-button>
    <ion-segment-button value="directions">
      <ion-label>üß≠ Directions & Routes</ion-label>
    </ion-segment-button>
  </ion-segment>
  
  <!-- Directions & Routes Tab Controls -->
  <ion-toolbar *ngIf="selectedTab === 'directions'" style="--min-height: 30px; padding: 4px 16px;">
    <!-- Loading indicator for jeepney routes -->
    <ion-item *ngIf="isLoadingJeepneyRoutes" lines="none" style="--min-height: 24px;">
      <ion-spinner name="crescent" style="width: 14px; height: 14px;"></ion-spinner>
      <ion-label style="font-size: 11px;">Loading jeepney routes...</ion-label>
    </ion-item>
    
    <!-- Route type selection prompt (compact) -->
    <ion-item *ngIf="selectedItineraryIndex < 0" lines="none" style="--min-height: 24px;">
      <ion-icon name="information-circle" color="warning" slot="start" style="font-size: 14px;"></ion-icon>
      <ion-label style="font-size: 11px;">
        <h3 style="font-size: 12px; margin: 0;">Select an Itinerary First</h3>
        <p style="font-size: 10px; margin: 1px 0;">Choose an itinerary from the dropdown below</p>
      </ion-label>
    </ion-item>
    

    

  </ion-toolbar>
  
  <!-- Itinerary and Route Type Selection (compact) -->
  <ion-toolbar *ngIf="selectedTab === 'directions'" class="itinerary-toolbar" style="--min-height: 40px; padding: 4px 16px;">
    <ion-item lines="none" class="itinerary-selector" style="--padding-start: 0; --padding-end: 0; --min-height: 32px;">
      <ion-label class="itinerary-label" style="margin: 0; min-width: 60px; font-size: 14px;">Itinerary:</ion-label>
      <ion-select 
        [(ngModel)]="selectedItineraryIndex" 
        (ionChange)="loadItineraryRoutes()" 
        interface="action-sheet" 
        [disabled]="availableItineraries.length === 0"
        class="itinerary-dropdown"
        style="--padding-start: 0; --padding-end: 0; font-size: 14px;"
        placeholder="Select an itinerary...">
        <ion-select-option value="-1" disabled>
          Select an itinerary...
        </ion-select-option>
        <ion-select-option *ngFor="let itinerary of availableItineraries; let i = index" [value]="i">
          {{ formatItineraryTitle(itinerary) }}
        </ion-select-option>
      </ion-select>
    </ion-item>
    
    <ion-button fill="clear" (click)="showUserLocation()" [color]="isRealLocation ? 'success' : 'warning'" size="small">
      <ion-icon name="location"></ion-icon>
      {{ locationStatusText }}
    </ion-button>
    <ion-button fill="clear" (click)="toggleLocationTracking()" 
                [color]="isLocationTrackingActive ? 'danger' : 'primary'" size="small">
      <ion-icon [name]="isLocationTrackingActive ? 'stop-circle' : 'play-circle'"></ion-icon>
      {{ isLocationTrackingActive ? 'Stop' : 'Track' }}
    </ion-button>

  </ion-toolbar>
</ion-header>

<ion-content [class.fullscreen-mode]="isFullscreen">
  <div id="map"></div>
  
  <!-- Floating Location Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="showUserLocation()" (press)="toggleLocationTracking()" 
                    [color]="isLocationTrackingActive ? 'danger' : (isRealLocation ? 'success' : 'warning')">
      <ion-icon [name]="isLocationTrackingActive ? 'navigate' : 'location'"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  
  <!-- Tourist Spots Tab Content -->
  <div *ngIf="selectedTab === 'spots'" class="map-controls">
    <ion-button expand="block" color="primary" (click)="navigateNextItineraryStep()" [disabled]="navigating">
      Navigate Next Itinerary Step
    </ion-button>
    <ion-list *ngIf="navigationInstructions.length > 0">
      <ion-item *ngFor="let instr of navigationInstructions">
        <div [innerHTML]="instr"></div>
      </ion-item>
    </ion-list>
  </div>
  
  <!-- Directions & Routes Tab Content -->
  <div *ngIf="selectedTab === 'directions'" class="directions-controls">
    <!-- Auto-loading indicator for jeepney route suggestions -->
    <ion-item *ngIf="selectedItineraryIndex >= 0 && availableItineraries.length > 0 && isLoadingJeepneyRoutes" lines="none" style="margin: 16px;">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>
        <h3>Loading jeepney routes...</h3>
        <p>Finding jeepney codes and walking directions for your itinerary</p>
      </ion-label>
    </ion-item>

    <!-- Loading indicator for route generation -->
    <ion-item *ngIf="selectedItineraryIndex >= 0 && availableItineraries.length > 0 && isGeneratingRoute" lines="none" style="margin: 16px;">
      <ion-spinner name="crescent" slot="start" color="warning"></ion-spinner>
      <ion-label>
        <h3>Generating Stage Routes...</h3>
        <p>Fetching jeepney routes from Google Maps API via proxy server</p>
      </ion-label>
    </ion-item>

    <!-- Route Information Display -->
    <div *ngIf="currentRouteInfo" class="route-suggestions">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Stage-Based Route</ion-card-title>
          <ion-card-subtitle>
            {{ currentRouteInfo.totalDuration }} ‚Ä¢ {{ currentRouteInfo.totalDistance }}
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <!-- Direct segments display -->
          <ion-list *ngIf="currentRouteInfo.segments && currentRouteInfo.segments.length > 0">
            <ion-item *ngFor="let segment of currentRouteInfo.segments; let i = index">
              <ion-icon [name]="segment.type === 'jeepney' ? 'bus' : 'walk'" 
                        [color]="segment.type === 'jeepney' ? 'primary' : 'medium'" 
                        slot="start"></ion-icon>
              <ion-label>
                <h3>{{ segment.description }}</h3>
                <p *ngIf="segment.jeepneyCode">Jeepney Code: {{ segment.jeepneyCode }}</p>
                <p>{{ segment.estimatedTime }} ‚Ä¢ Stage {{ segment.stage }}</p>
              </ion-label>
              <ion-button *ngIf="stageRouteOptions[segment.stage - 1] && stageRouteOptions[segment.stage - 1].length > 1" 
                          fill="clear" size="small" slot="end" 
                          (click)="showStageRouteOptions(segment.stage - 1)">
                <ion-icon name="options" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
          </ion-list>
          
          <!-- Alternative Routes for Each Stage -->
          <div *ngIf="selectedStageForOptions >= 0 && stageRouteOptions[selectedStageForOptions]" class="stage-route-options">
            <ion-card>
              <ion-card-header>
                <ion-card-title>Stage {{ selectedStageForOptions + 1 }} - Alternative Routes</ion-card-title>
                <ion-card-subtitle>Choose from {{ stageRouteOptions[selectedStageForOptions].length }} available options</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-list>
                  <ion-item *ngFor="let route of stageRouteOptions[selectedStageForOptions]; let i = index" 
                            [class.selected-route]="i === 0"
                            (click)="selectStageRoute(selectedStageForOptions, i)">
                    <ion-icon [name]="hasJeepneySegments(route) ? 'bus' : 'walk'" 
                              [color]="hasJeepneySegments(route) ? 'primary' : 'medium'" 
                              slot="start"></ion-icon>
                    <ion-label>
                      <h3>Option {{ i + 1 }}</h3>
                      <p *ngFor="let segment of route.segments">
                        <span *ngIf="segment.type === 'jeepney'">üöå {{ segment.jeepneyCode }} - {{ segment.description }}</span>
                        <span *ngIf="segment.type === 'walk'">üö∂‚Äç‚ôÇÔ∏è {{ segment.description }}</span>
                      </p>
                      <p>{{ formatDuration(route.totalDuration) }} ‚Ä¢ {{ (route.totalDistance / 1000).toFixed(1) }} km</p>
                    </ion-label>
                    <ion-badge *ngIf="i === 0" color="success" slot="end">Recommended</ion-badge>
                  </ion-item>
                </ion-list>
              </ion-card-content>
            </ion-card>
          </div>
          
          <!-- Suggested routes display (if available) -->
          <ion-list *ngIf="currentRouteInfo.suggestedRoutes && currentRouteInfo.suggestedRoutes.length > 0">
            <ion-item *ngFor="let route of currentRouteInfo.suggestedRoutes; let i = index" 
                      [class.selected-route]="i === currentRouteInfo.selectedRouteIndex"
                      (click)="selectRoute(i)">
              <ion-label>
                <h3>{{ route.title }}</h3>
                <p>{{ route.summary }}</p>
                <p>{{ route.totalDuration }} ‚Ä¢ {{ route.totalDistance }} ‚Ä¢ {{ route.totalFare }}</p>
              </ion-label>
              <ion-badge *ngIf="route.isRecommended" color="success" slot="end">Recommended</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Legacy Route Suggestions Display -->
    <div *ngIf="currentRouteInfo && currentRouteInfo.suggestedRoutes && !currentRouteInfo.segments" class="route-suggestions">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Route Suggestions</ion-card-title>
          <ion-card-subtitle>
            {{ currentRouteInfo.totalDuration }} ‚Ä¢ {{ currentRouteInfo.totalDistance }} ‚Ä¢ {{ currentRouteInfo.totalFare }}
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let route of currentRouteInfo.suggestedRoutes; let i = index" 
                      [class.selected-route]="i === currentRouteInfo.selectedRouteIndex"
                      (click)="selectRoute(i)">
              <ion-label>
                <h3>{{ route.title }}</h3>
                <p>{{ route.summary }}</p>
                <p>{{ route.totalDuration }} ‚Ä¢ {{ route.totalDistance }} ‚Ä¢ {{ route.totalFare }}</p>
              </ion-label>
              <ion-badge *ngIf="route.isRecommended" color="success" slot="end">Recommended</ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- No Route Info Message -->
    <ion-card *ngIf="selectedItineraryIndex < 0">
      <ion-card-content>
        <ion-text color="medium">
          <p>Select an itinerary to automatically show jeepney route suggestions</p>
        </ion-text>
      </ion-card-content>
    </ion-card>
  </div>
  
  <!-- Map Type Toggle Button -->
  <div [style.bottom]="isFullscreen ? '90px' : '170px'" style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" (click)="toggleMapType()">
    <ion-icon [name]="selectedTile === 'esri' ? 'earth' : 'map'" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <!-- Fullscreen Button -->
  <div [style.bottom]="isFullscreen ? '20px' : '100px'" style="position: fixed; right: 16px; z-index: 9999; background: #ffc107; padding: 10px; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: bottom 0.3s ease;" (click)="toggleFullscreen()">
    <ion-icon [name]="isFullscreen ? 'contract' : 'expand'" style="color: white; font-size: 24px;"></ion-icon>
  </div>
  
  <app-bottom-nav *ngIf="!isFullscreen"></app-bottom-nav>
</ion-content>